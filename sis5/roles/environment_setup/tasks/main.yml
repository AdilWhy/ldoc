---
# SIS 3: Environment Setup Role
# Purpose: Install and configure required packages and services

- name: Update apt cache
  apt:
    update_cache: yes
    cache_valid_time: 3600

- name: Install prerequisite packages for repository management
  apt:
    name:
      - apt-transport-https
      - software-properties-common
    state: present

- name: Add Grafana GPG key
  apt_key:
    url: https://apt.grafana.com/gpg.key
    state: present

- name: Add Grafana repository
  apt_repository:
    repo: deb https://apt.grafana.com stable main
    state: present
    filename: grafana

- name: Install required packages
  apt:
    name:
      - hugo
      - nginx
      - git
      - podman
      - prometheus
      - prometheus-node-exporter
      - grafana
      - rsyslog
      - ufw
      - certbot
      - python3-certbot-nginx
      - python3-pip
      - curl
      - wget
      - vim
      - htop
    state: present
    update_cache: yes

- name: Install Python packages for automation
  pip:
    name:
      - ansible
      - docker
      - requests
    state: present
    extra_args: --break-system-packages

- name: Enable and start Nginx service
  systemd:
    name: nginx
    enabled: yes
    state: started

- name: Enable and start Node Exporter
  systemd:
    name: prometheus-node-exporter
    enabled: yes
    state: started

- name: Enable and start Prometheus
  systemd:
    name: prometheus
    enabled: yes
    state: started

- name: Enable and start Grafana
  systemd:
    name: grafana-server
    enabled: yes
    state: started

- name: Configure UFW default policies
  ufw:
    policy: "{{ item.policy }}"
    direction: "{{ item.direction }}"
  loop:
    - { policy: 'deny', direction: 'incoming' }
    - { policy: 'allow', direction: 'outgoing' }

- name: Allow UFW services
  ufw:
    rule: allow
    port: "{{ item }}"
    proto: tcp
  loop:
    - "22"    # SSH
    - "80"    # HTTP
    - "443"   # HTTPS
    - "9090"  # Prometheus
    - "9100"  # Node Exporter
    - "3000"  # Grafana

- name: Enable UFW
  ufw:
    state: enabled

- name: Verify Hugo installation
  command: hugo version
  register: hugo_version
  changed_when: false

- name: Verify Podman installation
  command: podman --version
  register: podman_version
  changed_when: false

- name: Verify Prometheus installation
  command: prometheus --version
  register: prometheus_version
  changed_when: false

- name: Check Node Exporter metrics endpoint
  uri:
    url: http://localhost:9100/metrics
    method: GET
    status_code: 200
  register: node_exporter_check
  ignore_errors: yes

- name: Display environment setup results
  debug:
    msg:
      - "SIS 3: Environment setup completed"
      - "Hugo: {{ hugo_version.stdout }}"
      - "Podman: {{ podman_version.stdout }}"
      - "Prometheus: {{ prometheus_version.stdout_lines[0] }}"
      - "Node Exporter: {{ 'Running' if node_exporter_check.status == 200 else 'Check failed' }}"
